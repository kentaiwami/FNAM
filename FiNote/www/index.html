<!DOCTYPE html>
    <html>
        <head>
            <meta charset="UTF-8">
            <meta name="format-detection" content="telephone=no">
            <meta name="msapplication-tap-highlight" content="no">
            <meta name="viewport" content="user-scalable=no, initial-scale=1, minimum-scale=1, width=device-width" />

            <link rel="stylesheet" href="onsen/css/onsenui.css">
            <link rel="stylesheet" href="onsen/css/onsen-css-components.css">
            <link rel="stylesheet" href="css/index.css">

            <script src="js/index.js"></script>
            <script src="onsen/js/onsenui.js"></script>
            <script type="text/javascript" src="cordova.js"></script>
            <script type="text/javascript" src="js/ncmb.min.js" charset="utf-8"></script>
        </head>

        <body>

        <script>
           //delete_localstorage();

           //  var storage = window.localStorage;

           //  if (storage.getItem('movies') != null) {
           //      document.getElementById("test").innerHTML = "not null"
           //  }else{
           //      document.getElementById("test").innerHTML = "null"
           //  }
           // }
           //  check_page_init("movies",callback);

            var storage = window.localStorage;
            var signup_flag = storage.getItem('signup_flag');

            //ユーザ情報が登録されている場合は自動ログインを行う
            if (signup_flag == 'true') {
                //自動ログイン
                var ncmb = get_ncmb();
                var storage = window.localStorage;
                var username = storage.getItem('username');
                var password = storage.getItem('password');

                ncmb.User.login(username, password)
                    .then(function(data){
                        // ログイン後処理
                        //映画情報をデータベースから取得してtab.htmlへ遷移
                        var db = get_database();
                        db.transaction(function(tx) {
                            db.executeSql('SELECT COUNT(*) AS movie_count FROM movie', [], function(res) {
                                var movie_count = res.rows.item(0).movie_count;

                                if (movie_count == 0) {
                                    document.querySelector('#myNavigator').pushPage('tab.html', { animation : 'fade' } )

                                    var callback = function(){
                                        var nodata_message = document.getElementById("nodata_message");
                                        nodata_message.innerHTML = "登録された映画はありません";

                                        var pullHook = document.getElementById("pull-hook");
                                        pullHook.thresholdHeight = 200;
                                        pullHook.addEventListener('changestate', function(event) {
                                            var message = '';
                                            switch (event.state){
                                                case 'initial':
                                                message = 'Pull to refresh';
                                                break;
                                                case 'preaction':
                                                message = 'Release';
                                                break;
                                                case 'action':
                                                message = 'Loading...';
                                                break;
                                            }

                                        pullHook.innerHTML = message;
                                        });

                                        pullHook.onAction = function(done) {
                                            setTimeout(done, 1000);
                                            setTimeout(function(){nodata_message.innerHTML = "登録された映画はありません"}, 1000);
                                        };
                                    }

                                    check_page_init("movies",callback);
                                }else {
                                    //ons-listを生成して遷移
                                    document.querySelector('#myNavigator').pushPage('tab.html', { animation : 'fade' } )
                                }
                            });
                        }, function(err) {
                            console.log('SELECT movie ERROR: ' +JSON.stringify(err) +' ' + err.message);
                        });




                    })
                .catch(function(err){
                    // エラー処理
                    });

            //ユーザ情報が登録されていない場合はsignupへ遷移
            }else {
                //signup.htmlへ遷移
                var showpage = function(){
                            document.querySelector('#myNavigator').pushPage('signup.html', { animation : 'fade' } )
                        };
                setTimeout(showpage, 1000);
            }
        </script>
        <ons-navigator id="myNavigator" page="index.html"></ons-navigator>
        <!--index.htmlの設定-->
        <ons-template id="index.html">

          <ons-page id="index">
            <script>
                    //ユーザ情報が存在する場合はローディング画面を表示する
                    var storage = window.localStorage;
                    var signup_flag = storage.getItem('signup_flag');
                    if (signup_flag == 'true') {
                        document.write('<img  src="img/splash.gif" alt="" / width="100%" height="100%">');
                    }
            </script>
          </ons-page>
        </ons-template>

        <!--tab.htmlの設定-->
        <ons-template id="tab.html">
          <ons-page id="tab">
            <ons-tabbar position="bottom">
                <ons-tab page="movies.html" label="映画の一覧" icon="fa-square" active="true"></ons-tab>
                <ons-tab page="search.html" label="検索" icon="fa-square"></ons-tab>
                <ons-tab page="action.html" label="アクション" icon="fa-square"></ons-tab>
              </ons-tabbar>
          </ons-page>
        </ons-template>

        <!--movies.htmlの設定-->
        <ons-template id="movies.html">
          <ons-page id="movies">
            <!--ポップオーバーの設定-->
                <ons-popover direction="down" id="popover">
                    <div style="padding: 10px; text-align: center;">
                        <p><ons-button modifier="large"><i class="zmdi zmdi-view-list-alt"></i>　　リスト形式で表示</ons-button></p>
                        <p><ons-button modifier="large"><i class="zmdi zmdi-grid"></i>　グリッド形式で表示</ons-button></p>
                        <p><ons-button onclick="document.querySelector('#popover').hide()">閉じる</ons-button></p>
                    </div>
                </ons-popover>

                <!--ツールバー-->
                <ons-toolbar>
                    <div class="center">映画の一覧</div>
                    <div class="right">
                        <ons-toolbar-button onClick="document.querySelector('#myNavigator').pushPage('movieadd.html')">
                            <ons-icon icon="ion-ios-plus-empty"></ons-icon>
                        </ons-toolbar-button>
                    </div>

                    <div class="left">
                        <ons-toolbar-button onclick="document.querySelector('#popover').show(this)">
                            <ons-icon icon="ion-ios-settings"></ons-icon>
                        </ons-toolbar-button>
                    </div>
                </ons-toolbar>
                
                <ons-pull-hook id="pull-hook">
                    Pull to refresh
                </ons-pull-hook>

                <!-- <ons-list>
                    <ons-list-item>Item 1</ons-list-item>
                    <ons-list-item>Item 2</ons-list-item>
                    <ons-list-item>Item 3</ons-list-item>
                    <ons-list-item>Item 4</ons-list-item>
                    <ons-list-item>Item 5</ons-list-item>
                    <ons-list-item>Item 6</ons-list-item>
                </ons-list> -->
                <p id="nodata_message" style="text-align: center; opacity: 0.6; padding-top: 20px;"></p>
          </ons-page>
        </ons-template>

        <!--search.htmlの設定-->
        <ons-template id="search.html">
        <ons-page id="search">
        <!--ツールバー-->
                <ons-toolbar>
                    <div class="center">検索</div>
                </ons-toolbar>

                <p style="text-align: center; opacity: 0.6; padding-top: 20px;">
                  Search.html
                </p>
                </ons-page>
        </ons-template>

        <!--action.htmlの設定-->
        <ons-template id="action.html">
        <ons-page id="action">
        <!--ツールバー-->
                <ons-toolbar>
                    <div class="center">アクション</div>
                </ons-toolbar>

                <p style="text-align: center; opacity: 0.6; padding-top: 20px;">
                  Actions.html
                </p>
        </ons-page>
        </ons-template>

        <!--movieadd.htmlの設定-->
        <ons-template id="movieadd.html">
        <ons-page id="movieadd">
        <!--ツールバー-->
                <ons-toolbar>
                    <div class="center">映画の追加</div>
                    <div class="left">
                        <div class="left"><ons-back-button>映画の一覧</ons-back-button></div>
                    </div>
                </ons-toolbar>

                <p style="text-align: center; opacity: 0.6; padding-top: 20px;">
                  movieadd.html
                </p>
        </ons-page>
        </ons-template>

        <!--signup.htmlの設定-->
        <ons-template id="signup.html">
        <ons-page id="signup">
        <!--会員登録成功時のアラート設定-->
            <ons-alert-dialog id="signup-alert-success">
            <div class="alert-dialog-title">登録完了</div>
            <div class="alert-dialog-content">
                会員情報の登録に成功しました！
            </div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button" onclick="alert_hide('signup-alert-success')">OK</button>
            </div>
            </ons-alert-dialog>

            <!--会員登録失敗時のアラート設定-->
            <ons-alert-dialog id="signup-alert-error">
            <div class="alert-dialog-title">エラー</div>
            <div class="alert-dialog-content" id="error-message"></div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button" onclick="alert_hide('signup-alert-error')">OK</button>
            </div>
            </ons-alert-dialog>

            <ons-page>
            <ons-toolbar>
                <div class="center">ユーザ登録</div>
            </ons-toolbar>

            <div class="formarea">
                <div class="form-row">
                  <input type="text" id="username" class="text-input--underbar width-full" placeholder="ユーザ名" value="">
                </div>

                <div class="form-row">
                  <input type="password" id="password" class="text-input--underbar width-full" placeholder="パスワード" value="">
                </div>

                <div class="lucent">
                  <p class="note">Password - 6 characters or more</p>
                </div>

                <div class="vspc form-row">
                  <ons-button modifier="large--cta" onclick="signup()">登録</ons-button>
                </div>
              </div>
              </ons-page>
        </ons-page>
        </ons-template>
        </body>
    </html>
