<!DOCTYPE html>
    <html>
        <head>
            <meta charset="UTF-8">
            <meta name="format-detection" content="telephone=no">
            <meta name="msapplication-tap-highlight" content="no">
            <meta name="viewport" content="user-scalable=no, initial-scale=1, minimum-scale=1, width=device-width" />

            <link rel="stylesheet" href="onsen/css/onsenui.css">
            <link rel="stylesheet" href="onsen/css/onsen-css-components.css">
            <link rel="stylesheet" href="css/index.css">

            <script src="js/index.js"></script>
            <script src="js/jquery-3.1.0.min.js"></script>
            <script src="onsen/js/onsenui.js"></script>
            <script src="cordova.js"></script>
            <script src="js/ncmb.min.js" charset="utf-8"></script>
        </head>

        <body>

        <script>
           //delete_localstorage();

           //ブラウザでの確認のため強制的に遷移させるテストコード
           // check_page_init("index",function(){document.querySelector('#myNavigator').pushPage('movieadd.html')});


           //エラー表示用
           window.onerror = function(msg, url, line, col, error) {  
            console.log(msg);
           };

            var storage = window.localStorage;
            var signup_flag = storage.getItem('signup_flag');

            //ユーザ情報が登録されている場合は自動ログインを行う
            if (signup_flag == 'true') {
                //自動ログイン
                var ncmb = get_ncmb();
                var storage = window.localStorage;
                var username = storage.getItem('username');
                var password = storage.getItem('password');

                ncmb.User.login(username, password)
                    .then(function(data){
                        // ログイン後処理
                        //映画情報をデータベースから取得してtab.htmlへ遷移
                        var db = get_database();
                        db.transaction(function(tx) {
                            db.executeSql('SELECT COUNT(*) AS movie_count FROM movie', [], function(res) {

                                //movieのレコード数を取得後
                                document.querySelector('#myNavigator').pushPage('tab.html', { animation : 'fade' } )

                                var movie_count = res.rows.item(0).movie_count;
                                var callback = function(){};
                                var pullhook_setting = function(message){
                                    var pullHook = document.getElementById("pull-hook");
                                    pullHook.thresholdHeight = 200;
                                    pullHook.addEventListener('changestate', function(event) {
                                        var message = '';
                                        switch (event.state){
                                            case 'initial':
                                            message = 'Pull to refresh';
                                            break;
                                            case 'preaction':
                                            message = 'Release';
                                            break;
                                            case 'action':
                                            message = 'Loading...';
                                            break;
                                        }

                                        pullHook.innerHTML = message;
                                        });

                                        pullHook.onAction = function(done) {
                                            setTimeout(done, 1000);
                                            setTimeout(function(){nodata_message.innerHTML = message}, 1000);
                                        };
                                };

                                //ローカルに保存されている映画情報の件数で表示内容を変える
                                if (movie_count == 0) {
                                    callback = function(){
                                        var nodata_message = document.getElementById("nodata_message");
                                        nodata_message.innerHTML = "登録された映画はありません";

                                        pullhook_setting("登録された映画はありません");
                                    }
                                }else {
                                    callback = function(){
                                        var infiniteList = document.getElementById('infinite-list');

                                        var movie_title = "タイトルがここに入るタイトルがここに入る";
                                        var movie_thumbnail_path = "http://placekitten.com/g/40/40";
                                        var movie_subtitle = "追加日：yyyy/mm/dd";
                                      infiniteList.delegate = {
                                        createItemContent: function(i) {
                                          return ons._util.createElement(
                                            '<ons-list-item><div class="left"><img class="list__item__thumbnail_movie" src="' + movie_thumbnail_path +'"></div><div class="center"><span class="list__item__title">' + movie_title +'</span><span class="list__item__subtitle">' +movie_subtitle +'</span></div></ons-list-item>'
                                          );
                                        },
                                        countItems: function() {
                                          return movie_count;
                                        },
                                        calculateItemHeight: function() {
                                          return ons.platform.isAndroid() ? 48 : 100;
                                        }
                                      };

                                      infiniteList.refresh();

                                      pullhook_setting("");
                                    }
                                }

                                check_page_init("movies",callback);
                            });
                        }, function(err) {
                            console.log('SELECT movie ERROR: ' +JSON.stringify(err) +' ' + err.message);
                        });
                    })
                .catch(function(err){
                    // エラー処理
                    });

            //ユーザ情報が登録されていない場合はsignupへ遷移
            }else {
                //signup.htmlへ遷移
                var showpage = function(){
                            document.querySelector('#myNavigator').pushPage('signup.html', { animation : 'fade' } )
                        };
                setTimeout(showpage, 1000);
            }
        </script>
        <ons-navigator id="myNavigator" page="index.html"></ons-navigator>
        <!--index.htmlの設定-->
        <ons-template id="index.html">

          <ons-page id="index">
            <script>
                    //ユーザ情報が存在する場合はローディング画面を表示する
                    var storage = window.localStorage;
                    var signup_flag = storage.getItem('signup_flag');
                    if (signup_flag == 'true') {
                        document.write('<img  src="img/splash.gif" alt="" / width="100%" height="100%">');
                    }
            </script>
          </ons-page>
        </ons-template>

        <!--tab.htmlの設定-->
        <ons-template id="tab.html">
          <ons-page id="tab">
            <ons-tabbar position="bottom">
                <ons-tab page="movies.html" label="映画の一覧" icon="fa-square" active="true"></ons-tab>
                <ons-tab page="search.html" label="検索" icon="fa-square"></ons-tab>
                <ons-tab page="action.html" label="アクション" icon="fa-square"></ons-tab>
              </ons-tabbar>
          </ons-page>
        </ons-template>

        <!--movies.htmlの設定-->
        <ons-template id="movies.html">
          <ons-page id="movies">
            <!--ポップオーバーの設定-->
                <ons-popover direction="down" id="popover">
                    <div style="padding: 10px; text-align: center;">
                        <p><ons-button modifier="large"><i class="zmdi zmdi-view-list-alt"></i>　　リスト形式で表示</ons-button></p>
                        <p><ons-button modifier="large"><i class="zmdi zmdi-grid"></i>　グリッド形式で表示</ons-button></p>
                        <p><ons-button onclick="document.querySelector('#popover').hide()">閉じる</ons-button></p>
                    </div>
                </ons-popover>

                <!--ツールバー-->
                <ons-toolbar>
                    <div class="center">映画の一覧</div>
                    <div class="right">
                        <ons-toolbar-button onClick="document.querySelector('#myNavigator').pushPage('movieadd.html')">
                            <ons-icon icon="ion-ios-plus-empty"></ons-icon>
                        </ons-toolbar-button>
                    </div>

                    <div class="left">
                        <ons-toolbar-button onclick="document.querySelector('#popover').show(this)">
                            <ons-icon icon="ion-ios-settings"></ons-icon>
                        </ons-toolbar-button>
                    </div>
                </ons-toolbar>
                
                <ons-pull-hook id="pull-hook">
                    Pull to refresh
                </ons-pull-hook>

                <ons-list>
                    <ons-lazy-repeat id="infinite-list"></ons-lazy-repeat>
                </ons-list>
                <p id="nodata_message" style="text-align: center; opacity: 0.6; padding-top: 20px;"></p>
          </ons-page>
        </ons-template>

        <!--search.htmlの設定-->
        <ons-template id="search.html">
        <ons-page id="search">
        <!--ツールバー-->
                <ons-toolbar>
                    <div class="center">検索</div>
                </ons-toolbar>

                <p style="text-align: center; opacity: 0.6; padding-top: 20px;">
                  Search.html
                </p>
                </ons-page>
        </ons-template>

        <!--action.htmlの設定-->
        <ons-template id="action.html">
        <ons-page id="action">
        <!--ツールバー-->
                <ons-toolbar>
                    <div class="center">アクション</div>
                </ons-toolbar>

                <p style="text-align: center; opacity: 0.6; padding-top: 20px;">
                  Actions.html
                </p>
        </ons-page>
        </ons-template>

        <!--movieadd.htmlの設定-->
        <ons-template id="movieadd.html">
        <ons-page id="movieadd">
        <!--ツールバー-->
                <ons-toolbar>
                    <div class="left" id="movieadd_backbutton"><ons-back-button></ons-back-button></div>

                    <div class="center" id="movieadd_search_input">
                        <form action="javascript:click_done()">
                            <input onfocus="set_animation_movieadd_search_input('focus')" onblur="set_animation_movieadd_search_input('blur')" style="margin: 6px 0px; margin-left: -50px; width: 170%;" type="search" id="search_movie_title" value="" placeholder="追加する映画のタイトルを検索" class="search-input">
                        </form>
                    </div>

                    <div class="right">
                    	<ons-toolbar-button onclick="tap_cancel()" id="cancel_button" style="margin-left: 200px; width: 10px;"></ons-toolbar-button>
                        <!-- background-color: #E7D5E8 -->
                    </div>
                    
                    <div id="movieadd_reset"></div>
                </ons-toolbar>
        </ons-page>
        </ons-template>

        <!--signup.htmlの設定-->
        <ons-template id="signup.html">
        <ons-page id="signup">
        <!--会員登録成功時のアラート設定-->
            <ons-alert-dialog id="signup-alert-success">
            <div class="alert-dialog-title">登録完了</div>
            <div class="alert-dialog-content">
                会員情報の登録に成功しました！
            </div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button" onclick="alert_hide('signup-alert-success')">OK</button>
            </div>
            </ons-alert-dialog>

            <!--会員登録失敗時のアラート設定-->
            <ons-alert-dialog id="signup-alert-error">
            <div class="alert-dialog-title">エラー</div>
            <div class="alert-dialog-content" id="error-message"></div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button" onclick="alert_hide('signup-alert-error')">OK</button>
            </div>
            </ons-alert-dialog>

            <ons-page>
            <ons-toolbar>
                <div class="center">ユーザ登録</div>
            </ons-toolbar>

            <div class="formarea">
                <div class="form-row">
                  <input type="text" id="username" class="text-input--underbar width-full" placeholder="ユーザ名" value="">
                </div>

                <div class="form-row">
                  <input type="password" id="password" class="text-input--underbar width-full" placeholder="パスワード" value="">
                </div>

                <div class="lucent">
                  <p class="note">Password - 6 characters or more</p>
                </div>

                <div class="vspc form-row">
                  <ons-button modifier="large--cta" onclick="signup()">登録</ons-button>
                </div>
              </div>
              </ons-page>
        </ons-page>
        </ons-template>
        </body>
    </html>
